'use client';import { useEffect, useState } from 'react';import { auth, db, setupInvisibleRecaptcha } from '@/firebase/client';import { signInWithPhoneNumber, ConfirmationResult } from 'firebase/auth';import { doc, getDoc, serverTimestamp, setDoc } from 'firebase/firestore';import { useRouter, useSearchParams } from 'next/navigation';import { useTranslations } from 'next-intl';export default function PhoneAuth({locale}:{locale:'ar'|'en'}){const [phone,setPhone]=useState('');const [code,setCode]=useState('');const [confirmation,setConfirmation]=useState<ConfirmationResult|null>(null);const [loading,setLoading]=useState(false);const router=useRouter();const params=useSearchParams();const role=(params.get('role')||'client') as 'client'|'supplier';const t=useTranslations();useEffect(()=>{if(!document.getElementById('recaptcha-container')){const d=document.createElement('div');d.id='recaptcha-container';document.body.appendChild(d);}},[]);const sendCode=async()=>{setLoading(true);try{const v=setupInvisibleRecaptcha('recaptcha-container');const res=await signInWithPhoneNumber(auth, phone, v);setConfirmation(res);alert(t('success'));}catch(e){console.error(e);alert(t('error'));}finally{setLoading(false);}};const verify=async()=>{if(!confirmation) return;setLoading(true);try{const cred=await confirmation.confirm(code);const uid=cred.user.uid;const uref=doc(db,'Users',uid);const snap=await getDoc(uref);if(!snap.exists()){await setDoc(uref,{phone,role,status:'Pending',selected_language:locale,created_at:serverTimestamp()});}router.replace(`/${locale}/pending`);}catch(e){console.error(e);alert(t('error'));}finally{setLoading(false);}};return (<div>{!confirmation?(<div><input value={phone} onChange={e=>setPhone(e.target.value)} placeholder='+9665xxxxxxx'/><button onClick={sendCode} disabled={loading}>Send</button></div>):(<div><input value={code} onChange={e=>setCode(e.target.value)} placeholder='123456'/><button onClick={verify} disabled={loading}>Verify</button></div>)}</div>);}
